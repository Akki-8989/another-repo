name: Deploy to Azure

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch to deploy'
        required: false
        default: 'main'
      project_type:
        description: 'Project type'
        required: true
        default: 'backend'
        type: choice
        options:
          - backend
          - frontend

env:
  DOTNET_VERSION: '8.0.x'
  NODE_VERSION: '20.x'

jobs:
  detect-and-setup:
    runs-on: ubuntu-latest
    outputs:
      project_type: ${{ steps.detect.outputs.project_type }}
      project_path: ${{ steps.detect.outputs.project_path }}
      build_command: ${{ steps.detect.outputs.build_command }}
      output_path: ${{ steps.detect.outputs.output_path }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.ref || 'main' }}

    - name: Detect Project Type
      id: detect
      run: |
        PROJECT_TYPE="${{ github.event.inputs.project_type || 'backend' }}"
        
        # Auto-detect if not specified or validate
        if [ -f "package.json" ]; then
          if grep -q '"react"\|"vue"\|"@angular/core"\|"next"\|"vite"' package.json 2>/dev/null; then
            PROJECT_TYPE="frontend"
          fi
        fi
        
        if [ -f "*.csproj" ] || find . -name "*.csproj" -type f | head -1 | grep -q "."; then
          if [ "$PROJECT_TYPE" != "frontend" ]; then
            PROJECT_TYPE="backend"
          fi
        fi
        
        echo "project_type=$PROJECT_TYPE" >> $GITHUB_OUTPUT
        
        if [ "$PROJECT_TYPE" = "frontend" ]; then
          if [ -f "package.json" ]; then
            if grep -q '"next"' package.json; then
              echo "build_command=npm run build" >> $GITHUB_OUTPUT
              echo "output_path=out" >> $GITHUB_OUTPUT
            elif grep -q '"vite"\|"@vitejs"' package.json; then
              echo "build_command=npm run build" >> $GITHUB_OUTPUT
              echo "output_path=dist" >> $GITHUB_OUTPUT
            elif grep -q '"react-scripts"' package.json; then
              echo "build_command=npm run build" >> $GITHUB_OUTPUT
              echo "output_path=build" >> $GITHUB_OUTPUT
            elif grep -q '"@angular/core"' package.json; then
              echo "build_command=npm run build -- --configuration production" >> $GITHUB_OUTPUT
              echo "output_path=dist" >> $GITHUB_OUTPUT
            elif grep -q '"vue"' package.json; then
              echo "build_command=npm run build" >> $GITHUB_OUTPUT
              echo "output_path=dist" >> $GITHUB_OUTPUT
            else
              echo "build_command=npm run build" >> $GITHUB_OUTPUT
              echo "output_path=dist" >> $GITHUB_OUTPUT
            fi
          fi
          echo "project_path=." >> $GITHUB_OUTPUT
        else
          CSPROJ_PATH=$(find . -name "*.csproj" -type f | head -1)
          if [ -n "$CSPROJ_PATH" ]; then
            echo "project_path=$CSPROJ_PATH" >> $GITHUB_OUTPUT
          else
            echo "project_path=." >> $GITHUB_OUTPUT
          fi
          echo "build_command=dotnet build" >> $GITHUB_OUTPUT
          echo "output_path=publish" >> $GITHUB_OUTPUT
        fi
        
        echo "Detected project type: $PROJECT_TYPE"

  terraform:
    runs-on: ubuntu-latest
    needs: detect-and-setup
    outputs:
      webapp_name: ${{ steps.terraform_output.outputs.webapp_name }}
      resource_group: ${{ steps.terraform_output.outputs.resource_group }}
      static_webapp_name: ${{ steps.terraform_output.outputs.static_webapp_name }}
      deployment_token: ${{ steps.terraform_output.outputs.deployment_token }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.ref || 'main' }}

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: |
          {
            "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
            "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
            "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
            "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
          }

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_wrapper: false

    - name: Terraform Init
      working-directory: ./terraform
      run: terraform init

    - name: Import Existing Resources
      working-directory: ./terraform
      run: |
        APP_NAME="${{ github.event.repository.name }}"
        RG_NAME=$(echo "$APP_NAME" | tr '[:upper:]' '[:lower:]' | tr '_.' '--')-rg
        SUBSCRIPTION_ID="${{ secrets.AZURE_SUBSCRIPTION_ID }}"
        PROJECT_TYPE="${{ needs.detect-and-setup.outputs.project_type }}"
        RESOURCE_PREFIX=$(echo "$APP_NAME" | tr '[:upper:]' '[:lower:]' | tr '_.' '--')
        
        echo "=========================================="
        echo "Project Type: $PROJECT_TYPE"
        echo "Resource Prefix: $RESOURCE_PREFIX"
        echo "=========================================="
        
        # Function to import resource if exists in Azure but not in state
        import_if_exists() {
          local RESOURCE_TYPE=$1
          local RESOURCE_ADDRESS=$2
          local RESOURCE_ID=$3
          local CHECK_COMMAND=$4
          
          echo ""
          echo "--- Checking $RESOURCE_TYPE ---"
          
          # Check if already in Terraform state
          if terraform state list 2>/dev/null | grep -q "$RESOURCE_ADDRESS"; then
            echo "$RESOURCE_TYPE: Already in Terraform state - SKIP"
            return 0
          fi
          
          # Check if exists in Azure
          if eval "$CHECK_COMMAND" > /dev/null 2>&1; then
            echo "$RESOURCE_TYPE: EXISTS in Azure, importing..."
            terraform import \
              -var="app_name=$APP_NAME" \
              -var="project_type=$PROJECT_TYPE" \
              "$RESOURCE_ADDRESS" "$RESOURCE_ID" && echo "$RESOURCE_TYPE: Import SUCCESS" || echo "$RESOURCE_TYPE: Import FAILED (may not exist)"
          else
            echo "$RESOURCE_TYPE: Does NOT exist in Azure - will be created"
          fi
        }
        
        # 1. Resource Group
        import_if_exists \
          "Resource Group" \
          "azurerm_resource_group.main" \
          "/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RG_NAME" \
          "az group exists --name $RG_NAME | grep -q true"
        
        # Backend Resources
        if [ "$PROJECT_TYPE" = "backend" ]; then
          
          # 2. App Service Plan
          import_if_exists \
            "App Service Plan" \
            "azurerm_service_plan.main[0]" \
            "/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RG_NAME/providers/Microsoft.Web/serverFarms/${RESOURCE_PREFIX}-plan" \
            "az appservice plan show --name ${RESOURCE_PREFIX}-plan --resource-group $RG_NAME"
          
          # 3. Web App
          import_if_exists \
            "Web App" \
            "azurerm_windows_web_app.main[0]" \
            "/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RG_NAME/providers/Microsoft.Web/sites/${RESOURCE_PREFIX}-webapp" \
            "az webapp show --name ${RESOURCE_PREFIX}-webapp --resource-group $RG_NAME"
          
          # 4. SQL Server (if SQL password is provided)
          if [ -n "${{ secrets.SQL_ADMIN_PASSWORD }}" ]; then
            import_if_exists \
              "SQL Server" \
              "azurerm_mssql_server.main[0]" \
              "/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RG_NAME/providers/Microsoft.Sql/servers/${RESOURCE_PREFIX}-sqlserver" \
              "az sql server show --name ${RESOURCE_PREFIX}-sqlserver --resource-group $RG_NAME"
            
            # 5. SQL Database
            import_if_exists \
              "SQL Database" \
              "azurerm_mssql_database.main[0]" \
              "/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RG_NAME/providers/Microsoft.Sql/servers/${RESOURCE_PREFIX}-sqlserver/databases/${RESOURCE_PREFIX}-db" \
              "az sql db show --name ${RESOURCE_PREFIX}-db --server ${RESOURCE_PREFIX}-sqlserver --resource-group $RG_NAME"
            
            # 6. SQL Firewall Rule
            import_if_exists \
              "SQL Firewall Rule" \
              "azurerm_mssql_firewall_rule.allow_azure[0]" \
              "/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RG_NAME/providers/Microsoft.Sql/servers/${RESOURCE_PREFIX}-sqlserver/firewallRules/AllowAzureServices" \
              "az sql server firewall-rule show --name AllowAzureServices --server ${RESOURCE_PREFIX}-sqlserver --resource-group $RG_NAME"
          fi
        fi
        
        # Frontend Resources
        if [ "$PROJECT_TYPE" = "frontend" ]; then
          
          # Static Web App
          import_if_exists \
            "Static Web App" \
            "azurerm_static_web_app.main[0]" \
            "/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RG_NAME/providers/Microsoft.Web/staticSites/${RESOURCE_PREFIX}-static" \
            "az staticwebapp show --name ${RESOURCE_PREFIX}-static --resource-group $RG_NAME"
        fi
        
        echo ""
        echo "=========================================="
        echo "Import process completed"
        echo "=========================================="

    - name: Terraform Plan
      working-directory: ./terraform
      run: |
        PROJECT_TYPE="${{ needs.detect-and-setup.outputs.project_type }}"
        
        if [ -n "${{ secrets.SQL_ADMIN_PASSWORD }}" ] && [ "$PROJECT_TYPE" = "backend" ]; then
          terraform plan \
            -var="app_name=${{ github.event.repository.name }}" \
            -var="project_type=$PROJECT_TYPE" \
            -var="sql_admin_password=${{ secrets.SQL_ADMIN_PASSWORD }}" \
            -out=tfplan
        else
          terraform plan \
            -var="app_name=${{ github.event.repository.name }}" \
            -var="project_type=$PROJECT_TYPE" \
            -out=tfplan
        fi

    - name: Terraform Apply
      working-directory: ./terraform
      run: terraform apply -auto-approve tfplan

    - name: Get Terraform Outputs
      id: terraform_output
      working-directory: ./terraform
      run: |
        echo "resource_group=$(terraform output -raw resource_group)" >> $GITHUB_OUTPUT
        
        PROJECT_TYPE="${{ needs.detect-and-setup.outputs.project_type }}"
        
        if [ "$PROJECT_TYPE" = "backend" ]; then
          echo "webapp_name=$(terraform output -raw webapp_name)" >> $GITHUB_OUTPUT
        else
          echo "static_webapp_name=$(terraform output -raw static_webapp_name)" >> $GITHUB_OUTPUT
          echo "deployment_token=$(terraform output -raw static_webapp_api_key)" >> $GITHUB_OUTPUT
        fi

  build-backend:
    runs-on: ubuntu-latest
    needs: [detect-and-setup, terraform]
    if: needs.detect-and-setup.outputs.project_type == 'backend'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.ref || 'main' }}

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore ${{ needs.detect-and-setup.outputs.project_path }}

    - name: Build
      run: dotnet build ${{ needs.detect-and-setup.outputs.project_path }} --configuration Release --no-restore

    - name: Publish
      run: dotnet publish ${{ needs.detect-and-setup.outputs.project_path }} --configuration Release --output ./publish --no-build

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: webapp-artifact
        path: ./publish

  build-frontend:
    runs-on: ubuntu-latest
    needs: [detect-and-setup, terraform]
    if: needs.detect-and-setup.outputs.project_type == 'frontend'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.ref || 'main' }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build
      run: ${{ needs.detect-and-setup.outputs.build_command }}
      env:
        CI: false

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: frontend-artifact
        path: ${{ needs.detect-and-setup.outputs.output_path }}

  deploy-backend:
    runs-on: ubuntu-latest
    needs: [detect-and-setup, terraform, build-backend]
    if: needs.detect-and-setup.outputs.project_type == 'backend'

    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: webapp-artifact
        path: ./publish

    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: |
          {
            "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
            "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
            "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
            "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
          }

    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ needs.terraform.outputs.webapp_name }}
        package: ./publish

  deploy-frontend:
    runs-on: ubuntu-latest
    needs: [detect-and-setup, terraform, build-frontend]
    if: needs.detect-and-setup.outputs.project_type == 'frontend'

    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: frontend-artifact
        path: ./dist

    - name: Deploy to Azure Static Web App
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ needs.terraform.outputs.deployment_token }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: "upload"
        app_location: "./dist"
        skip_app_build: true
